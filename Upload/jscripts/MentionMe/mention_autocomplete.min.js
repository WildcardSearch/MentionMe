var MentionMe=(function(m){var textarea={},container={},items=[],maxItems=5,options={minLength:3,maxLength:30,},lang={loading:'loading . . .',instructions:'type a user name',},fullEditor=false,textAreaPadding=4,cursorPointer='pointer',selection={start:0,end:0,},key={BACKSPACE:8,NEWLINE:10,ENTER:13,ESC:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,DEL:46,},selectionRange,positioner,cache={},popup={},keyCache={};function setup(opt){Object.extend(lang,opt.lang||{});delete opt.lang;Object.extend(options,opt||{});}
function init(){var id='message';if(typeof clickableEditor!='undefined'){id=clickableEditor.textarea;fullEditor=true;textAreaPadding=2;}
if(!$(id)){return;}
if(MyBB.browser=='ie'){cursorPointer='hand';}
textarea=$(id);container=textarea.up('div');popup.init();positioner=new maxkir.CursorPosition(textarea,textAreaPadding);selectionRange=new maxkir.SelectionRange(textarea);Event.observe(textarea,'keyup',onKeyUp);if(m.autoComplete.debug){m.autoComplete.debug.init();}}
function onKeyUp(event){if(!popup.isVisible()){if(event.keyCode==50&&event.shiftKey==true){popup.show();}
return;}
getCaret();switch(event.keyCode){case key.ESC:popup.hide();break;case key.LEFT:case key.RIGHT:keyCache.checkCaret(event.keyCode);break;default:if(keyCache.update()){popup.update();}}}
function onKeyDown(event){switch(event.keyCode){case key.ENTER:insertMention();break;case key.UP:popup.select('previous');break;case key.DOWN:popup.select('next');break;case key.END:popup.select('last');break;case key.HOME:popup.select();break;case key.PAGE_UP:popup.select('previousPage');break;case key.PAGE_DOWN:popup.select('nextPage');break;default:return;}
Event.stop(event);}
function insertMention(){var lPad=' ',rPad=' ',name=popup.getSelectedName(),offset=keyCache.getOffset(),mention,prevChar,quote='';if(!name){if(!popup.spinnerIsVisible()){popup.hide();}
return;}
prevChar=textarea.value.charCodeAt(offset-2);if(offset<=1||prevChar==key.SPACE||prevChar==key.ENTER||prevChar==key.NEWLINE){lPad='';}
if(selection.start>=textarea.length||textarea.value.slice(selection.start,selection.start+1)==' '){rPad='';}
getCaret();if(name.indexOf('"')==-1){quote='"';}else if(name.indexOf("'")==-1){quote="'";}else if(name.indexOf("`")==-1){quote="`";}
mention=lPad+'@'+quote+name+quote+rPad;textarea.value=textarea.value.slice(0,offset-1)+mention+textarea.value.slice(offset+keyCache.getLength());setCaret(offset+mention.length-1);popup.hide();}
function getCaret(){var range=selectionRange.get_selection_range();selection.start=range[0];selection.end=range[1];}
function setCaret(position){if(textarea.setSelectionRange){textarea.focus();textarea.setSelectionRange(position,position);}else if(textarea.createTextRange){var range=textarea.createTextRange();range.collapse(true);range.moveEnd('character',position);range.moveStart('character',position);range.select();}}
keyCache=(function(){var data='',mirror='',offset=0,caret=0;function init(){data='';getCaret();offset=selection.start;mirror=textarea.value;caret=0;}
function update(){if(textarea.value==mirror){return false;}
var insertedChars=(textarea.value.length-mirror.length),newData;if(textarea.value.length<offset||selection.start<offset||data.length+insertedChars>options.maxLength){popup.hide();return false;}
newData=textarea.value.slice(offset,offset+data.length+insertedChars);updateCaret();if(newData==data){return false;}
data=newData;mirror=textarea.value;return true;}
function checkCaret(code){if(selection.start<offset||selection.start>offset+data.length||(offset+caret==textarea.value.length&&code==key.RIGHT)){popup.hide();}
updateCaret();}
function updateCaret(){caret=selection.start-offset;}
function getLength(){return data.length;}
function getText(natural){if(natural!=true){return data.toLowerCase();}
return data;}
function getOffset(){return offset;}
return{init:init,update:update,checkCaret:checkCaret,getLength:getLength,getText:getText,getOffset:getOffset,};})();cache=(function(){var data={},ready=false,loading=false,searching=false,searched=[];function init(){loading=true;new Ajax.Request('xmlhttp.php',{parameters:{action:'mentionme',mode:'get_name_cache'},onSuccess:loadNameCache});}
function loadNameCache(transport){ready=true;loading=false;data=transport.responseJSON||{};if(data.length===0){data={};popup.showInstructions();move();return;}
if(popup.isVisible()){popup.update();}}
function match(){var property,i=0;items=[];for(property in data){if(!data.hasOwnProperty(property)||!data[property]||(keyCache.getLength()&&property.slice(0,keyCache.getLength())!=keyCache.getText())){continue;}
items.push(data[property]);i++;}
items=items.sortBy(function(s){return s.length;});return i;}
function search(){var search=keyCache.getText().slice(0,options.minLength);if(searching||searched.indexOf(search)!=-1){if(popup.spinnerIsVisible()){popup.hide();}
return;}
searched.push(search);searching=true;if(items.length===0){popup.showSpinner();}
new Ajax.Request('xmlhttp.php',{parameters:{action:'mentionme',mode:'name_search',search:search,},onSuccess:load});}
function load(transport){var n=0,property,names=transport.responseJSON;searching=false;if(names==null){if(popup.spinnerIsVisible()){popup.hide();}
return;}
for(property in names){if(!names.hasOwnProperty(property)||data[property]){continue;}
data[property]=names[property];n++;}
if(!n||!popup.isVisible()){return;}
match();popup.buildItems();popup.select();}
function isReady(){return ready;}
function isLoading(){return loading;}
return{init:init,match:match,search:search,isReady:isReady,isLoading:isLoading,};})();popup=(function(){var visible=false,selected=0,lastSelected=null,div,spinner,spinnerVisible=false,lineHeight,width=0;function init(){var e;div=new Element('div',{id:'mentionme_popup','class':'mentionme_popup',}).setStyle({left:'-1000px',top:'-1000px',});container.insert(div);div.show();for(e=0;e<maxItems;e++){div.insert(new Element('div').update(Array(options.maxLength+1).join('M')));}
lineHeight=parseInt(div.offsetHeight/maxItems);width=div.getStyle('fontSize').replace('px','')*(options.maxLength-1);spinner=new Element('div',{id:'mentionme_spinner','class':'mentionme_spinner',}).insert(new Element('img',{src:'images/spinner.gif',}));spinner.insert(new Element('span').update(lang.loading));div.update(spinner);}
function show(){var coords=positioner.getPixelCoordinates(),taCoords=textarea.viewportOffset(),left,top;if(!cache.isReady()&&!cache.isLoading()){cache.init();}
keyCache.init();popup.update();if(fullEditor){left=coords[0];top=coords[1]+clickableEditor.toolbarHeight+lineHeight;}else{left=taCoords[0]+coords[0];top=taCoords[1]+coords[1]+DomLib.getPageScroll()[1];}
move(left,top);div.show();lastSelected=null;select();visible=true;Event.observe(div,'mouseover',onMouseMove);Event.observe(div,'click',onClick);Event.observe(document,'click',hide);Event.observe(textarea,'click',hide);Event.observe(textarea,'keydown',onKeyDown);}
function hide(){div.hide();Event.stopObserving(div,'mouseover',onMouseMove);Event.stopObserving(div,'click',onClick);Event.stopObserving(document,'click',hide);Event.stopObserving(textarea,'click',hide);Event.stopObserving(textarea,'keydown',onKeyDown);visible=false;}
function clear(){div.update('');lastSelected=null;spinnerVisible=false;}
function update(){if(!cache.isReady()){popup.showSpinner();return;}
cache.match();buildItems();lastSelected=null;select();if(keyCache.getLength()>=options.minLength){cache.search();}}
function buildItems(){var thisClass;if(items.length===0&&spinnerVisible==false){if(keyCache.getLength()>0){clear();div.update(keyCache.getText());}else{showInstructions();}
move();return;}
clear();for(i=0;i<items.length;i++){div.insert(new Element('div',{id:'mentionme_popup_item_'+i,'class':'mentionme_popup_item'}).update(items[i]).setStyle({cursor:cursorPointer,}));}
move();}
function move(left,top){var style={height:getCurrentHeight()+'px',overflow:'auto',width:width+'px',};if(left){style.left=left+'px';}
if(top){style.top=top+'px';}
div.setStyle(style);}
function highlightSelected(noScroll){if(lastSelected==selected||!$('mentionme_popup_item_'+selected)){return;}
var selectedItem=$('mentionme_popup_item_'+selected);if($('mentionme_popup_item_'+lastSelected)){$('mentionme_popup_item_'+lastSelected).removeClassName('mentionme_popup_item_on');}
lastSelected=selected;if(selectedItem&&!selectedItem.hasClassName('mentionme_popup_item_on')){selectedItem.addClassName('mentionme_popup_item_on');}
if(noScroll!=true){selectedItem.up('div').scrollTop=selectedItem.offsetTop;}}
function onMouseMove(event){if(selectEventTarget(event)){highlightSelected(true);}}
function onClick(event){if(selectEventTarget(event)){insertMention();}else{Event.stop(event);}}
function selectEventTarget(event){if(!event){return false;}
var idParts,target=event.findElement();try{if(!target||!target.id||target.id=='mentionme_popup'||target.id=='mentionme_spinner'){return false;}}catch(e){return false;}
idParts=target.id.split('_');if(!idParts||idParts.length==0||!idParts[idParts.length-1]){return false;}
selected=idParts[idParts.length-1];return true;}
function getSelectedName(){if(items.length===0||!items[selected]){return;}
return items[selected];}
function select(selection){switch(selection){case'last':selected=items.length-1;break;case'next':selected++;if(selected>items.length-1){selected=0;}
break;case'previous':selected--;if(selected<0){selected=items.length-1;}
break;case'nextPage':selected+=maxItems;if(selected>items.length-1){selected=items.length-1;}
break;case'previousPage':selected-=maxItems;if(selected<0){selected=0;}
break;default:selected=0;break;}
highlightSelected();}
function spinnerIsVisible(){return spinnerVisible;}
function showSpinner(){clear();div.update(spinner);spinnerVisible=true;move();}
function showInstructions(){clear();div.update('<span style="color: grey; font-style: italic;">'+lang.instructions+'</span>');}
function getCurrentHeight(){return(lineHeight*Math.max(1,Math.min(5,items.length)))+4;}
function isVisible(){return visible;}
return{init:init,hide:hide,show:show,clear:clear,update:update,buildItems:buildItems,select:select,getSelectedName:getSelectedName,showSpinner:showSpinner,isVisible:isVisible,spinnerIsVisible:spinnerIsVisible,showInstructions:showInstructions,};})();m.autoComplete={init:init,setup:setup,};return m;})(MentionMe||{});Event.observe(window,'load',MentionMe.autoComplete.init);