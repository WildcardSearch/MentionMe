/*
 * Plugin Name: MentionMe for MyBB 1.8.x
 * Copyright 2014 WildcardSearch
 * http://www.rantcentralforums.com
 *
 * this file contains a module for the auto-completion functionality
 */

var MentionMe=function(b,t){
"use strict";
function m(c){var a=this.id.split("_").slice(-1)[0],d="quickedit_"+a,h;0!=b("#"+d).length&&("undefined"===typeof CKEDITOR?h=new r(d):setTimeout(function(){h=new u(d)},1100),setTimeout(function(){b("#quicksub_"+a).add(b("#quicksub_"+a).next("button")).click(function(){h.unbindKeyup()})},1100))}function w(c){b(".quick_edit_button").off("click",m);setTimeout(function(){b(".quick_edit_button").click(m)},500)}function n(b){b=b.getSelectedName();var a="";if(b)return-1==b.indexOf('"')?
a='"':-1==b.indexOf("'")?a="'":-1==b.indexOf("`")&&(a="`"),a+b+a+" "}function p(b){return-1===[e.LEFT,e.RIGHT,e.UP,e.DOWN,e.BACKSPACE,e.ESC,e.SHIFT,e.CTRL,e.ALT,e.ENTER,e.DELETE,e.INSERT,e.END,e.NUMLOCK].indexOf(b)}function x(b,a){return b.length<a.length?-1:b.length>a.length?1:0}var f={minLength:2,maxLength:30,maxItems:5,tid:"",fullText:0,showAvatars:1,imageDirectory:"images",lockSelection:1},v={instructions:"type a user name"},e={BACKSPACE:8,ENTER:13,SHIFT:16,CTRL:17,ALT:18,ESC:27,PAGE_UP:33,PAGE_DOWN:34,
END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,INSERT:45,DELETE:46,NUMLOCK:144},q=function(){function c(a){this.editorInterface=a;a=this.editorInterface.getContainer();this.$popup=b("#mentionme_master_popup").clone().attr("id","");this.$spinner=this.$popup.find("div.mentionme_spinner").hide();this.$input=this.$popup.find("input.mentionme_popup_input");this.$inputDiv=this.$popup.find("div.mentionme_popup_input_container");this.$body=this.$popup.find("div.mentionme_popup_body");if("string"===typeof a&&
b("#"+a).length)this.$container=b("#"+a);else if("object"===typeof a&&b(a).length)this.$container=b(a);else return!1;this.$container.append(this.$popup);this.$popup.css({left:"-1000px",top:"-1000px"}).show();this.inputHeight=this.$inputDiv.height();a=b("<div/>");f.showAvatars&&b("<img/>",{"class":"mention_user_avatar",src:f.defaultAvatar}).appendTo(a);a.append(Array(f.maxLength+1).join("M")).addClass("mentionme_popup_item");this.$body.html(a);this.lineHeight=parseInt(a.height(),10)+this.editorInterface.lineHeightModifier+
parseInt(a.css("paddingTop").replace("px",""),10)+parseInt(a.css("paddingBottom").replace("px",""),10);this.$instructions=b("<span/>",{"class":"mentionme_popup_instructions"}).html(v.instructions);this.scrollWidthDiff=this.$body.width()-this.$body[0].scrollWidth;this.keyCache=new y(this);this.nameCache=new z(this)}b.extend(c.prototype,{show:function(a,d){this.keyCache.clear();this.update();this.move(a,d);this.$popup.show();this.lastSelected=null;this.select();this.visible=!0;this.$body.mouseover(b.proxy(this.onMouseMove,
this));this.$body.click(b.proxy(this.onClick,this));b(document).click(b.proxy(this.hide,this));this.editorInterface.bindClick(b.proxy(this.hide,this));this.$input.keydown(b.proxy(this.onKeyDown,this));this.$input.keyup(b.proxy(this.updateCheck,this));this.$input.click(b.proxy(this.onInputClick,this));this.$input.focus()},hide:function(){this.$popup.hide();this.$body.off("mouseover",this.onMouseMove);this.$body.off("click",this.onClick);b(document).off("click",this.hide);this.editorInterface.unbindClick(this.hide);
this.$input.off("keydown",this.onKeyDown);this.$input.off("keyup",this.updateCheck);this.$input.off("click",this.onInputClick);this.visible=!1;this.$input.val("")},move:function(a,d){var h=this.nameCache.getLongestName();this.width=0;if(f.showAvatars){var c=b("<img/>",{"class":"mention_user_avatar",src:f.defaultAvatar}).css({left:"-1000px",top:"-1000px"}).appendTo(this.$container);this.width+=c.width();c.remove()}this.width+=parseInt(this.$body.css("fontSize").replace("px","")*h,10);h={height:this.getCurrentHeight()+
this.inputHeight+"px",width:parseInt(this.width-this.scrollWidthDiff,10)+"px"};"undefined"!=typeof a&&(h.left=a+"px");"undefined"!=typeof d&&(h.top=d+"px");this.$popup.css(h);this.$body.css({height:this.getCurrentHeight()+"px",width:this.width})},update:function(){this.nameCache.isReady()?(this.nameCache.match(),this.buildItems(),this.lastSelected=null,this.select(),this.keyCache.getLength()>=f.minLength&&this.nameCache.search()):this.showSpinner()},buildItems:function(){var a,d=this.nameCache.getItemsLength(),
h=this.nameCache.getData(),c=-1!==navigator.userAgent.toLowerCase().indexOf("msie")?"hand":"pointer";this.items=this.nameCache.getItems();if(0===d&&0==this.spinnerVisible)0<this.keyCache.getLength()?(this.clear(),this.$body.html(b("<span/>",{"class":"mentionme_typed_text"}).html(this.keyCache.getText()))):this.showInstructions();else for(this.clear(),a=0;a<d;a++){var e=this.items[a];var l=h[e].username;if(this.keyCache.getText()){var g=e.indexOf(this.keyCache.getText());if(f.fullText&&-1!==g||!f.fullText&&
0===g)l=l.slice(0,g)+'<span class="mention_name_highlight">'+l.slice(g,g+this.keyCache.getLength())+"</span>"+l.slice(g+this.keyCache.getLength())}g="";f.showAvatars&&(e=h[e].avatar,0==e.length&&(e=f.defaultAvatar),g=b("<img/>",{"class":"mention_user_avatar",src:e}).one("error",function(){this.src=f.defaultAvatar}));this.$body.append(b("<div/>",{"class":"mentionme_popup_item mentionme_popup_item_"+a}).append(g).append(l).css({cursor:c}))}this.isVisible()&&this.move()},clear:function(){this.$body.html("");
this.lastSelected=null;this.spinnerVisible=!1;this.isVisible()&&this.move()},showSpinner:function(){this.clear();this.$body.html(this.$spinner);this.spinnerVisible=!0;this.isVisible()&&this.move()},showInstructions:function(){this.clear();this.$body.html(this.$instructions)},updateCheck:function(){this.keyCache.update()&&this.update()},select:function(a){var d=this.nameCache.getItemsLength()-1;switch(a){case "last":this.selected=d;break;case "next":this.selected++;this.selected>d&&(this.selected=
0);break;case "previous":this.selected--;0>this.selected&&(this.selected=d);break;case "nextPage":this.selected+=f.maxItems;this.selected>d&&(this.selected=d);break;case "previousPage":this.selected-=f.maxItems;0>this.selected&&(this.selected=0);break;default:this.selected=0}this.highlightSelected()},highlightSelected:function(a){var d=this.$popup.find(".mentionme_popup_item_"+this.selected),b=this.$popup.find(".mentionme_popup_item_"+this.lastSelected),c=b.find("span.mention_name_highlight_on"),
e=this.itemInView(d);this.lastSelected!=this.selected&&0!=d.length&&(b.length&&(b.removeClass("mentionme_popup_item_on"),c.length&&(c.removeClass("mention_name_highlight_on"),c.addClass("mention_name_highlight"))),this.lastSelected=this.selected,d&&(d.hasClass("mentionme_popup_item_on")||d.addClass("mentionme_popup_item_on"),c=d.find("span.mention_name_highlight"),c.length&&(c.removeClass("mention_name_highlight"),c.addClass("mention_name_highlight_on"))),a||1!==f.lockSelection&&!0===e||(f.lockSelection?
0<this.nameCache.getItemsLength()-f.maxItems&&this.$body.prop("scrollTop",parseInt(d.prop("offsetTop")-this.inputHeight,10)):0==this.selected?this.$body.prop("scrollTop",-this.inputHeight):0<e?this.$body.prop("scrollTop",parseInt(d.prop("offsetTop")-(this.getCurrentHeight()-this.lineHeight)-this.inputHeight,10)):this.$body.prop("scrollTop",parseInt(d.prop("offsetTop")-this.inputHeight,10))))},itemInView:function(a){a=a.prop("offsetTop")-this.$body.prop("scrollTop");return 0<a&&a+this.lineHeight<this.getCurrentHeight()?
!0:a},onKeyDown:function(a){switch(a.keyCode){case e.ENTER:this.editorInterface.insert();break;case e.UP:this.select("previous");break;case e.DOWN:this.select("next");break;case e.END:this.select("last");break;case e.HOME:this.select();break;case e.PAGE_UP:this.select("previousPage");break;case e.PAGE_DOWN:this.select("nextPage");break;case e.ESC:this.hide();break;case e.BACKSPACE:""===this.$input.val()&&(this.hide(),this.editorInterface.focus());return;default:return}a.preventDefault()},onMouseMove:function(a){this.selectEventTarget(a)&&
this.highlightSelected(!0)},onClick:function(a){this.selectEventTarget(a)?this.editorInterface.insert():a.preventDefault()},onInputClick:function(a){a.stopPropagation()},selectEventTarget:function(a){if(!a)return!1;var d=b(a.target),c;a=!1;if(0!=d.length&&d.hasClass("mentionme_popup_item")){for(d=d.prop("class").split(" ");c=d.shift();)if("undefined"!==typeof c&&-1===["mentionme_popup_item","mentionme_popup_item_on"].indexOf(c)&&0===c.indexOf("mentionme_popup_item_")){a=!0;break}d=c.split("_");if(!a||
!d||0==d.length||!d[d.length-1])return!1;this.selected=d[d.length-1];return!0}},getSelectedName:function(){if(0!==this.nameCache.getItemsLength()&&this.items[this.selected])return this.nameCache.getData()[this.items[this.selected]].username},getCurrentHeight:function(){return this.lineHeight*Math.max(1,Math.min(f.maxItems,this.nameCache.getItemsLength()))+this.editorInterface.heightModifier+4},getInputValue:function(){return this.$input.val()},getLineHeight:function(){return this.lineHeight},spinnerIsVisible:function(){return this.spinnerVisible},
isVisible:function(){return this.visible}});return c}(),y=function(){function c(a){this.popup=a;this.clear()}b.extend(c.prototype,{clear:function(){this.mirror=this.data=""},update:function(){var a=!1,d=this.popup.getInputValue();this.data!==d&&(a=!0);this.data=d;return a},getLength:function(){return this.data.length},getText:function(a){return 1!=a?this.data.toLowerCase():this.data}});return c}(),z=function(){function c(a){this.data={};this.threadNames={};this.allNames={};this.ready=!1;this.loading=
!0;this.searching=!1;this.searched=[];this.items=[];this.longestName=5;this.popup=a;this.editorInterface=this.popup.editorInterface;this.keyCache=a.keyCache;b.ajax({type:"post",url:"xmlhttp.php",data:{action:"mentionme",mode:"getNameCache",tid:f.tid},success:this.loadNameCache.bind(this)})}function a(a){var d=0,b;this.searching=!1;if(a){for(b in a)a.hasOwnProperty(b)&&!this.data[b]&&(this.data[b]=a[b],d++);d&&this.popup.isVisible()&&(this.match(),this.popup.buildItems(),this.popup.select())}else this.popup.spinnerIsVisible()&&
(this.popup.hide(),this.editorInterface.focus())}b.extend(c.prototype,{loadNameCache:function(a){this.ready=!0;this.loading=!1;this.threadNames=a.inThread;this.allNames=a.cached;b.extend(this.data,this.threadNames,this.allNames);b.isEmptyObject(this.data)?(this.data={},this.popup.showInstructions(),this.popup.isVisible()&&this.popup.move()):this.popup.isVisible()&&this.popup.update()},match:function(){var a,c=0,e={},f=[];this.items=[];this.longestName=5;for(a in this.threadNames)this.checkEntry(a,
this.threadNames,e)&&(this.items.push(a),e[a]=!0,c++);for(a in this.data)this.checkEntry(a,this.data,e)&&(f.push(a),e[a]=!0,c++);f=f.sort(x);b.merge(this.items,f);return c},checkEntry:function(a,b,c){if(!b.hasOwnProperty(a)||!b[a]||c[a]||this.keyCache.getLength()&&(!f.fullText&&a.slice(0,this.keyCache.getLength())!==this.keyCache.getText()||f.fullText&&-1===a.indexOf(this.keyCache.getText())))return!1;a.length>this.longestName&&(this.longestName=a.length);return!0},search:function(){var d=this.keyCache.getText().slice(0,
f.minLength);this.searching||-1!==this.searched.indexOf(d)?this.popup.spinnerIsVisible()&&(this.popup.hide(),this.editorInterface.focus()):(this.searched.push(d),this.searching=!0,0===this.items.length&&this.popup.showSpinner(),b.ajax({type:"post",url:"xmlhttp.php",data:{action:"mentionme",mode:"nameSearch",search:d},success:a.bind(this)}))},load:a,isReady:function(){return this.ready},isLoading:function(){return this.loading},getData:function(){return this.data},getItems:function(){return this.items},
getItemsLength:function(){return this.items.length},getLongestName:function(){return this.longestName}});return c}(),r=function(){function c(a){this.$textarea=b("#"+a);this.$container=this.$textarea.closest("div");this.selection={start:0,end:0};this.popup=new q(this);this.bindKeyup()}b.extend(c.prototype,{heightModifier:0,lineHeightModifier:0,onKeyUp:function(a){this.popup.isVisible()||(this.getCaret(),p(a.keyCode)&&"@"==this.$textarea.val().slice(this.selection.start-1,this.selection.end)&&this.showPopup())},
showPopup:function(){var a=this.$textarea.caret("offset");this.popup.show(a.left+3,a.top-5)},insert:function(){var a=n(this.popup);a?(this.getCaret(),this.$textarea.val(this.$textarea.val().slice(0,this.selection.start)+a+this.$textarea.val().slice(this.selection.start)),this.setCaret(this.selection.start+a.length),this.popup.hide()):this.popup.spinnerIsVisible()||this.popup.hide()},getCaret:function(){var a=this.$textarea.caret("pos");this.selection.start=a;this.selection.end=a},setCaret:function(a){var d=
this.$textarea[0];d.setSelectionRange?(d.focus(),d.setSelectionRange(a,a)):d.createTextRange&&(d=d.createTextRange(),d.collapse(!0),d.moveEnd("character",a),d.moveStart("character",a),d.select())},bindClick:function(a){this.$textarea.click(a)},unbindClick:function(a){this.$textarea.off("click",a)},bindKeyup:function(){this.$textarea.keyup(b.proxy(this.onKeyUp,this))},unbindKeyup:function(){this.$textarea.off("keyup")},focus:function(){this.$textarea.focus()},getContainer:function(){return this.$container}});
return c}(),A=function(){function c(){this.editor=MyBBEditor;this.rangeHelper=this.editor.getRangeHelper();this.$iFrame=b("iframe");this.$container=this.$iFrame.closest("td");this.$body=this.editor.getBody();this.selection={start:0,end:0};this.popup=new q(this);this.editor.keyUp(this.onKeyUp.bind(this))}b.extend(c.prototype,{heightModifier:0,lineHeightModifier:0,onKeyUp:function(a){this.getCaret();if(!a.keyCode)if(a.originalEvent&&a.originalEvent.keyCode)a.keyCode=a.originalEvent.keyCode;else return;
this.popup.isVisible()||p(a.keyCode)&&"@"==this.$currentNode.text().slice(this.selection.start-1,this.selection.end)&&this.showPopup()},showPopup:function(){var a=this.$body.caret("offset",{iframe:this.$iFrame[0]});var d=this.$container.offset();var b=7;this.$currentNode.closest("div").length&&"function"===typeof this.$currentNode.closest("div").css&&(b=parseInt(this.$currentNode.closest("div").css("fontSize").replace("px","")/2,10));b=parseInt(a.left,10)+d.left+parseInt(this.$container.css("paddingLeft").replace("px",
""),10)+b+2;a=parseInt(a.top+this.$container.find("div.sceditor-toolbar").height(),10)+d.top+parseInt(this.$container.css("paddingTop").replace("px",""),10)+3;this.popup.show(b,a)},insert:function(){var a=n(this.popup);a?(this.editor.insert(a),this.popup.hide()):this.popup.spinnerIsVisible()||this.popup.hide()},getCaret:function(){var a=this.rangeHelper.selectedRange();this.$currentNode=a.startContainer?b(a.startContainer):b(editor.currentNode());this.selection.start=a.startOffset;this.selection.end=
a.endOffset},bindClick:function(a){this.$body.click(a)},unbindClick:function(a){this.$body.off("click",a)},focus:function(){this.$iFrame.focus()},getContainer:function(){return this.$container}});return c}(),u=function(){function c(a){if(0!==b("#"+a).length&&"undefined"!==typeof CKEDITOR.instances[a]){this.id=a;this.editor=CKEDITOR.instances[this.id];if("message"===a||"signature"===a)this.editor.on("instanceReady",b.proxy(this.finalize,this));else this.finalize();b("#quick_reply_submit").click(b.proxy(this.quickReplyPosted,
this))}}b.extend(c.prototype,{heightModifier:0,lineHeightModifier:0,finalize:function(){this.doFinalize();this.lastState=this.editor.mode;this.editor.on("mode",b.proxy(this.onModeChange,this))},doFinalize:function(){this.$iFrame=b("#cke_"+this.id).find("iframe");this.$container=this.$iFrame.closest("div");this.$doc=b(this.editor.document.$);this.$body=this.$doc.find("body");this.bindKeyup();this.popup=new q(this)},onModeChange:function(a){"undefined"!=typeof a.sender.mode&&a.sender.mode!=this.lastState&&
(this.lastState=a.sender.mode,"source"==a.sender.mode?this.unbindKeyup():this.doFinalize())},onKeyUp:function(a){this.popup.isVisible()||p(a.keyCode)&&"@"==this.getPrevChar()&&this.showPopup()},quickReplyPosted:function(){"undefined"!==typeof this.$doc&&this.$doc.length&&this.$doc.off("keyup",this.onKeyUp);setTimeout(b.proxy(function(){this.$doc.keyup(b.proxy(this.onKeyUp,this))},this),500)},showPopup:function(){var a=this.$body.caret("offset",{iframe:this.$iFrame[0]}),d=this.$iFrame.offset(),b=parseInt(a.left+
d.left,10)+2;a=parseInt(a.top+d.top,10)-5;this.popup.show(b,a)},insert:function(){var a=n(this.popup);a?(this.editor.insertText(a),this.popup.hide()):this.popup.spinnerIsVisible()||this.popup.hide()},getPrevChar:function(){var a=this.editor.getSelection().getRanges()[0];if(!a||!a.startContainer)return null;var d=a.startContainer;if(d.type==CKEDITOR.NODE_TEXT&&a.startOffset)return d.getText()[a.startOffset-1];a.collapse(!0);a.setStartAt(this.editor.editable(),CKEDITOR.POSITION_AFTER_START);for(d=new CKEDITOR.dom.walker(a);a=
d.previous();)if(a.type==CKEDITOR.NODE_TEXT)return a.getText().slice(-1);return null},bindClick:function(a){this.$doc.click(a)},unbindClick:function(a){this.$doc.off("click",a)},bindKeyup:function(){this.$doc.keyup(b.proxy(this.onKeyUp,this))},unbindKeyup:function(){this.$doc.off("keyup",this.onKeyUp)},focus:function(){this.editor.focus()},getContainer:function(){return this.$container}});return c}();b(function(){if("undefined"!==typeof CKEDITOR&&"undefined"!==typeof CKEDITOR.instances){var c=b.map(CKEDITOR.instances,
function(a,d){return d})[0];if("object"!==typeof CKEDITOR.instances[c])return!1;new u(c)}else if(null!==MyBBEditor&&"object"===typeof MyBBEditor&&MyBBEditor.getRangeHelper&&"function"===typeof MyBBEditor.getRangeHelper)new A;else if(0<b("#message").length||0<b("#signature").length){b("#message").length?c="message":b("#signature").length&&(c="signature");if(!c||!b("#"+c).length)return!1;new r(c)}b(".quick_edit_button").click(m);b("#quick_reply_submit").click(w)});t.autoComplete={setup:function(c){b.extend(v,
c.lang||{});delete c.lang;b.extend(f,c||{});b("minLength maxLength maxItems fullText showAvatars lockSelection".split(" ")).each(function(){"undefined"!==typeof f[this]&&(f[this]=parseInt(f[this],10))});f.defaultAvatar=f.imageDirectory+"/default_avatar.png"}};return t}(jQuery,MentionMe||{});MentionMe=function(b,t){function m(c){var a=this.id.split("_").slice(-1)[0],d="quickedit_"+a,e;0!=b("#"+d).length&&("undefined"===typeof CKEDITOR?e=new r(d):setTimeout(function(){e=new u(d)},1100),setTimeout(function(){b("#quicksub_"+a).add(b("#quicksub_"+a).next("button")).click(function(){e.unbindKeyup()})},1100))}function w(c){b(".quick_edit_button").off("click",m);setTimeout(function(){b(".quick_edit_button").click(m)},500)}function n(b){b=b.getSelectedName();var a="";if(b)return-1==b.indexOf('"')?
a='"':-1==b.indexOf("'")?a="'":-1==b.indexOf("`")&&(a="`"),a+b+a+" "}function p(b){return-1===[e.LEFT,e.RIGHT,e.UP,e.DOWN,e.BACKSPACE,e.ESC,e.SHIFT,e.CTRL,e.ALT,e.ENTER,e.DELETE,e.INSERT,e.END,e.NUMLOCK].indexOf(b)}function x(b,a){return b.length<a.length?-1:b.length>a.length?1:0}var f={minLength:2,maxLength:30,minWidth:120,maxItems:5,tid:"",fullText:0,showAvatars:1,imageDirectory:"images",lockSelection:1},v={instructions:"type a user name"},e={BACKSPACE:8,ENTER:13,SHIFT:16,CTRL:17,ALT:18,ESC:27,
PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,INSERT:45,DELETE:46,NUMLOCK:144},q=function(){function c(a){this.editorInterface=a;a=this.editorInterface.getContainer();this.$popup=b("#mentionme_master_popup").clone().attr("id","");this.$spinner=this.$popup.find("div.mentionme_spinner").hide();this.$input=this.$popup.find("input.mentionme_popup_input");this.$inputDiv=this.$popup.find("div.mentionme_popup_input_container");this.$body=this.$popup.find("div.mentionme_popup_body");
if("string"===typeof a&&b("#"+a).length)this.$container=b("#"+a);else if("object"===typeof a&&b(a).length)this.$container=b(a);else return!1;this.$container.append(this.$popup);this.$popup.css({left:"-1000px",top:"-1000px"}).show();this.inputHeight=this.$inputDiv.height();a=b("<div/>");f.showAvatars&&b("<img/>",{"class":"mention_user_avatar",src:f.defaultAvatar}).appendTo(a);a.append(Array(f.maxLength+1).join("M")).addClass("mentionme_popup_item");this.$body.html(a);this.lineHeight=parseInt(a.height(),
10)+this.editorInterface.lineHeightModifier+parseInt(a.css("paddingTop").replace("px",""),10)+parseInt(a.css("paddingBottom").replace("px",""),10);this.$instructions=b("<span/>",{"class":"mentionme_popup_instructions"}).html(v.instructions);this.scrollWidthDiff=this.$body.width()-this.$body[0].scrollWidth;this.keyCache=new y(this);this.nameCache=new z(this)}b.extend(c.prototype,{show:function(a,d){this.keyCache.clear();this.update();this.move(a,d);this.$popup.show();this.lastSelected=null;this.select();
this.visible=!0;this.$body.mouseover(b.proxy(this.onMouseMove,this));this.$body.click(b.proxy(this.onClick,this));b(document).click(b.proxy(this.hide,this));this.editorInterface.bindClick(b.proxy(this.hide,this));this.$input.keydown(b.proxy(this.onKeyDown,this));this.$input.keyup(b.proxy(this.updateCheck,this));this.$input.click(b.proxy(this.onInputClick,this));this.$input.focus()},hide:function(){this.$popup.hide();this.$body.off("mouseover",this.onMouseMove);this.$body.off("click",this.onClick);
b(document).off("click",this.hide);this.editorInterface.unbindClick(this.hide);this.$input.off("keydown",this.onKeyDown);this.$input.off("keyup",this.updateCheck);this.$input.off("click",this.onInputClick);this.visible=!1;this.$input.val("")},move:function(a,d){var c=this.nameCache.getLongestName();this.width=0;if(f.showAvatars){var e=b("<img/>",{"class":"mention_user_avatar",src:f.defaultAvatar}).css({left:"-1000px",top:"-1000px"}).appendTo(this.$container);this.width+=e.width();e.remove()}this.width+=
parseInt(this.$body.css("fontSize").replace("px","")*c,10);this.width=Math.max(f.minWidth,this.width);c={height:this.getCurrentHeight()+this.inputHeight+"px",width:parseInt(this.width-this.scrollWidthDiff,10)+"px"};"undefined"!=typeof a&&(c.left=a+"px");"undefined"!=typeof d&&(c.top=d+"px");this.$popup.css(c);this.$body.css({height:this.getCurrentHeight()+"px",width:this.width})},update:function(){this.nameCache.isReady()?(this.nameCache.match(),this.buildItems(),this.lastSelected=null,this.select(),
this.keyCache.getLength()>=f.minLength&&this.nameCache.search()):this.showSpinner()},buildItems:function(){var a,d=this.nameCache.getItemsLength(),c=this.nameCache.getData(),e=-1!==navigator.userAgent.toLowerCase().indexOf("msie")?"hand":"pointer";this.items=this.nameCache.getItems();if(0===d&&0==this.spinnerVisible)0<this.keyCache.getLength()?(this.clear(),this.$body.html(b("<span/>",{"class":"mentionme_typed_text"}).html(this.keyCache.getText()))):this.showInstructions();else for(this.clear(),a=
0;a<d;a++){var k=this.items[a];var l=c[k].username;if(this.keyCache.getText()){var g=k.indexOf(this.keyCache.getText());if(f.fullText&&-1!==g||!f.fullText&&0===g)l=l.slice(0,g)+'<span class="mention_name_highlight">'+l.slice(g,g+this.keyCache.getLength())+"</span>"+l.slice(g+this.keyCache.getLength())}g="";f.showAvatars&&(k=c[k].avatar,"undefined"==typeof k?k=f.defaultAvatar:0==k.length&&(k=f.defaultAvatar),g=b("<img/>",{"class":"mention_user_avatar",src:k}).one("error",function(){this.src=f.defaultAvatar}));
this.$body.append(b("<div/>",{"class":"mentionme_popup_item mentionme_popup_item_"+a}).append(g).append(l).css({cursor:e}))}this.isVisible()&&this.move()},clear:function(){this.$body.html("");this.lastSelected=null;this.spinnerVisible=!1;this.isVisible()&&this.move()},showSpinner:function(){this.clear();this.$body.html(this.$spinner);this.spinnerVisible=!0;this.isVisible()&&this.move()},showInstructions:function(){this.clear();this.$body.html(this.$instructions)},updateCheck:function(){this.keyCache.update()&&
this.update()},select:function(a){var b=this.nameCache.getItemsLength()-1;switch(a){case "last":this.selected=b;break;case "next":this.selected++;this.selected>b&&(this.selected=0);break;case "previous":this.selected--;0>this.selected&&(this.selected=b);break;case "nextPage":this.selected+=f.maxItems;this.selected>b&&(this.selected=b);break;case "previousPage":this.selected-=f.maxItems;0>this.selected&&(this.selected=0);break;default:this.selected=0}this.highlightSelected()},highlightSelected:function(a){var b=
this.$popup.find(".mentionme_popup_item_"+this.selected),c=this.$popup.find(".mentionme_popup_item_"+this.lastSelected),e=c.find("span.mention_name_highlight_on"),k=this.itemInView(b);this.lastSelected!=this.selected&&0!=b.length&&(c.length&&(c.removeClass("mentionme_popup_item_on"),e.length&&(e.removeClass("mention_name_highlight_on"),e.addClass("mention_name_highlight"))),this.lastSelected=this.selected,b&&(b.hasClass("mentionme_popup_item_on")||b.addClass("mentionme_popup_item_on"),e=b.find("span.mention_name_highlight"),
e.length&&(e.removeClass("mention_name_highlight"),e.addClass("mention_name_highlight_on"))),a||1!==f.lockSelection&&!0===k||(f.lockSelection?0<this.nameCache.getItemsLength()-f.maxItems&&this.$body.prop("scrollTop",parseInt(b.prop("offsetTop")-this.inputHeight,10)):0==this.selected?this.$body.prop("scrollTop",-this.inputHeight):0<k?this.$body.prop("scrollTop",parseInt(b.prop("offsetTop")-(this.getCurrentHeight()-this.lineHeight)-this.inputHeight,10)):this.$body.prop("scrollTop",parseInt(b.prop("offsetTop")-
this.inputHeight,10))))},itemInView:function(a){a=a.prop("offsetTop")-this.$body.prop("scrollTop");return 0<a&&a+this.lineHeight<this.getCurrentHeight()?!0:a},onKeyDown:function(a){switch(a.keyCode){case e.ENTER:this.editorInterface.insert();break;case e.UP:this.select("previous");break;case e.DOWN:this.select("next");break;case e.END:this.select("last");break;case e.HOME:this.select();break;case e.PAGE_UP:this.select("previousPage");break;case e.PAGE_DOWN:this.select("nextPage");break;case e.ESC:this.hide();
break;case e.BACKSPACE:""===this.$input.val()&&(this.hide(),this.editorInterface.focus());return;default:return}a.preventDefault()},onMouseMove:function(a){this.selectEventTarget(a)&&this.highlightSelected(!0)},onClick:function(a){this.selectEventTarget(a)?this.editorInterface.insert():a.preventDefault()},onInputClick:function(a){a.stopPropagation()},selectEventTarget:function(a){if(!a)return!1;var d=b(a.target),c;a=!1;if(0!=d.length&&d.hasClass("mentionme_popup_item")){for(d=d.prop("class").split(" ");c=
d.shift();)if("undefined"!==typeof c&&-1===["mentionme_popup_item","mentionme_popup_item_on"].indexOf(c)&&0===c.indexOf("mentionme_popup_item_")){a=!0;break}d=c.split("_");if(!a||!d||0==d.length||!d[d.length-1])return!1;this.selected=d[d.length-1];return!0}},getSelectedName:function(){if(0!==this.nameCache.getItemsLength()&&this.items[this.selected])return this.nameCache.getData()[this.items[this.selected]].username},getCurrentHeight:function(){return this.lineHeight*Math.max(1,Math.min(f.maxItems,
this.nameCache.getItemsLength()))+this.editorInterface.heightModifier+4},getInputValue:function(){return this.$input.val()},getLineHeight:function(){return this.lineHeight},spinnerIsVisible:function(){return this.spinnerVisible},isVisible:function(){return this.visible}});return c}(),y=function(){function c(a){this.popup=a;this.clear()}b.extend(c.prototype,{clear:function(){this.mirror=this.data=""},update:function(){var a=!1,b=this.popup.getInputValue();this.data!==b&&(a=!0);this.data=b;return a},
getLength:function(){return this.data.length},getText:function(a){return 1!=a?this.data.toLowerCase():this.data}});return c}(),z=function(){function c(a){this.data={};this.threadNames={};this.allNames={};this.ready=!1;this.loading=!0;this.searching=!1;this.searched=[];this.items=[];this.longestName=5;this.popup=a;this.editorInterface=this.popup.editorInterface;this.keyCache=a.keyCache;b.ajax({type:"post",url:"xmlhttp.php",data:{action:"mentionme",mode:"getNameCache",tid:f.tid},success:this.loadNameCache.bind(this)})}
function a(a){var b=0,d;this.searching=!1;if(a){for(d in a)a.hasOwnProperty(d)&&!this.data[d]&&(this.data[d]=a[d],b++);b&&this.popup.isVisible()&&(this.match(),this.popup.buildItems(),this.popup.select())}else this.popup.spinnerIsVisible()&&(this.popup.hide(),this.editorInterface.focus())}b.extend(c.prototype,{loadNameCache:function(a){this.ready=!0;this.loading=!1;this.threadNames=a.inThread;this.allNames=a.cached;b.extend(this.data,this.threadNames,this.allNames);b.isEmptyObject(this.data)?(this.data=
{},this.popup.showInstructions(),this.popup.isVisible()&&this.popup.move()):this.popup.isVisible()&&this.popup.update()},match:function(){var a,c=0,e={},f=[];this.items=[];this.longestName=5;for(a in this.threadNames)this.checkEntry(a,this.threadNames,e)&&(this.items.push(a),e[a]=!0,c++);for(a in this.data)this.checkEntry(a,this.data,e)&&(f.push(a),e[a]=!0,c++);f=f.sort(x);b.merge(this.items,f);return c},checkEntry:function(a,b,c){if(!b.hasOwnProperty(a)||!b[a]||c[a]||this.keyCache.getLength()&&(!f.fullText&&
a.slice(0,this.keyCache.getLength())!==this.keyCache.getText()||f.fullText&&-1===a.indexOf(this.keyCache.getText())))return!1;a.length>this.longestName&&(this.longestName=a.length);return!0},search:function(){var d=this.keyCache.getText().slice(0,f.minLength);this.searching||-1!==this.searched.indexOf(d)?this.popup.spinnerIsVisible()&&(this.popup.hide(),this.editorInterface.focus()):(this.searched.push(d),this.searching=!0,0===this.items.length&&this.popup.showSpinner(),b.ajax({type:"post",url:"xmlhttp.php",
data:{action:"mentionme",mode:"nameSearch",search:d},success:a.bind(this)}))},load:a,isReady:function(){return this.ready},isLoading:function(){return this.loading},getData:function(){return this.data},getItems:function(){return this.items},getItemsLength:function(){return this.items.length},getLongestName:function(){return this.longestName}});return c}(),r=function(){function c(a){this.$textarea=b("#"+a);this.$container=this.$textarea.closest("div");this.selection={start:0,end:0};this.popup=new q(this);
this.bindKeyup()}b.extend(c.prototype,{heightModifier:0,lineHeightModifier:0,onKeyUp:function(a){this.popup.isVisible()||(this.getCaret(),p(a.keyCode)&&"@"==this.$textarea.val().slice(this.selection.start-1,this.selection.end)&&this.showPopup())},showPopup:function(){var a=this.$textarea.caret("offset");this.popup.show(a.left+3,a.top-5)},insert:function(){var a=n(this.popup);a?(this.getCaret(),this.$textarea.val(this.$textarea.val().slice(0,this.selection.start)+a+this.$textarea.val().slice(this.selection.start)),
this.setCaret(this.selection.start+a.length),this.popup.hide()):this.popup.spinnerIsVisible()||this.popup.hide()},getCaret:function(){var a=this.$textarea.caret("pos");this.selection.start=a;this.selection.end=a},setCaret:function(a){var b=this.$textarea[0];b.setSelectionRange?(b.focus(),b.setSelectionRange(a,a)):b.createTextRange&&(b=b.createTextRange(),b.collapse(!0),b.moveEnd("character",a),b.moveStart("character",a),b.select())},bindClick:function(a){this.$textarea.click(a)},unbindClick:function(a){this.$textarea.off("click",
a)},bindKeyup:function(){this.$textarea.keyup(b.proxy(this.onKeyUp,this))},unbindKeyup:function(){this.$textarea.off("keyup")},focus:function(){this.$textarea.focus()},getContainer:function(){return this.$container}});return c}(),A=function(){function c(){this.editor=MyBBEditor;this.rangeHelper=this.editor.getRangeHelper();this.$iFrame=b("iframe");this.$container=this.$iFrame.closest("td");this.$body=this.editor.getBody();this.selection={start:0,end:0};this.popup=new q(this);this.editor.keyUp(this.onKeyUp.bind(this))}
b.extend(c.prototype,{heightModifier:0,lineHeightModifier:0,onKeyUp:function(a){this.getCaret();if(!a.keyCode)if(a.originalEvent&&a.originalEvent.keyCode)a.keyCode=a.originalEvent.keyCode;else return;this.popup.isVisible()||p(a.keyCode)&&"@"==this.$currentNode.text().slice(this.selection.start-1,this.selection.end)&&this.showPopup()},showPopup:function(){var a=this.$body.caret("offset",{iframe:this.$iFrame[0]});var b=this.$container.offset();var c=7;this.$currentNode.closest("div").length&&"function"===
typeof this.$currentNode.closest("div").css&&(c=parseInt(this.$currentNode.closest("div").css("fontSize").replace("px","")/2,10));c=parseInt(a.left,10)+b.left+parseInt(this.$container.css("paddingLeft").replace("px",""),10)+c+2;a=parseInt(a.top+this.$container.find("div.sceditor-toolbar").height(),10)+b.top+parseInt(this.$container.css("paddingTop").replace("px",""),10)+3;this.popup.show(c,a)},insert:function(){var a=n(this.popup);a?(this.editor.insert(a),this.popup.hide()):this.popup.spinnerIsVisible()||
this.popup.hide()},getCaret:function(){var a=this.rangeHelper.selectedRange();this.$currentNode=a.startContainer?b(a.startContainer):b(editor.currentNode());this.selection.start=a.startOffset;this.selection.end=a.endOffset},bindClick:function(a){this.$body.click(a)},unbindClick:function(a){this.$body.off("click",a)},focus:function(){this.$iFrame.focus()},getContainer:function(){return this.$container}});return c}(),u=function(){function c(a){if(0!==b("#"+a).length&&"undefined"!==typeof CKEDITOR.instances[a]){this.id=
a;this.editor=CKEDITOR.instances[this.id];if("message"===a||"signature"===a)this.editor.on("instanceReady",b.proxy(this.finalize,this));else this.finalize();b("#quick_reply_submit").click(b.proxy(this.quickReplyPosted,this))}}b.extend(c.prototype,{heightModifier:0,lineHeightModifier:0,finalize:function(){this.doFinalize();this.lastState=this.editor.mode;this.editor.on("mode",b.proxy(this.onModeChange,this))},doFinalize:function(){this.$iFrame=b("#cke_"+this.id).find("iframe");this.$container=this.$iFrame.closest("div");
this.$doc=b(this.editor.document.$);this.$body=this.$doc.find("body");this.bindKeyup();this.popup=new q(this)},onModeChange:function(a){"undefined"!=typeof a.sender.mode&&a.sender.mode!=this.lastState&&(this.lastState=a.sender.mode,"source"==a.sender.mode?this.unbindKeyup():this.doFinalize())},onKeyUp:function(a){this.popup.isVisible()||p(a.keyCode)&&"@"==this.getPrevChar()&&this.showPopup()},quickReplyPosted:function(){"undefined"!==typeof this.$doc&&this.$doc.length&&this.$doc.off("keyup",this.onKeyUp);
setTimeout(b.proxy(function(){this.$doc.keyup(b.proxy(this.onKeyUp,this))},this),500)},showPopup:function(){var a=this.$body.caret("offset",{iframe:this.$iFrame[0]}),b=this.$iFrame.offset(),c=parseInt(a.left+b.left,10)+2;a=parseInt(a.top+b.top,10)-5;this.popup.show(c,a)},insert:function(){var a=n(this.popup);a?(this.editor.insertText(a),this.popup.hide()):this.popup.spinnerIsVisible()||this.popup.hide()},getPrevChar:function(){var a=this.editor.getSelection().getRanges()[0];if(!a||!a.startContainer)return null;
var b=a.startContainer;if(b.type==CKEDITOR.NODE_TEXT&&a.startOffset)return b.getText()[a.startOffset-1];a.collapse(!0);a.setStartAt(this.editor.editable(),CKEDITOR.POSITION_AFTER_START);for(b=new CKEDITOR.dom.walker(a);a=b.previous();)if(a.type==CKEDITOR.NODE_TEXT)return a.getText().slice(-1);return null},bindClick:function(a){this.$doc.click(a)},unbindClick:function(a){this.$doc.off("click",a)},bindKeyup:function(){this.$doc.keyup(b.proxy(this.onKeyUp,this))},unbindKeyup:function(){this.$doc.off("keyup",
this.onKeyUp)},focus:function(){this.editor.focus()},getContainer:function(){return this.$container}});return c}();b(function(){var c=b('.panel > form > input[class="text"]');if("undefined"!==typeof CKEDITOR&&"undefined"!==typeof CKEDITOR.instances){var a=b.map(CKEDITOR.instances,function(a,b){return b})[0];if("object"!==typeof CKEDITOR.instances[a])return!1;new u(a)}else if(null!==MyBBEditor&&"object"===typeof MyBBEditor&&MyBBEditor.getRangeHelper&&"function"===typeof MyBBEditor.getRangeHelper)new A;
else if(0<b("#message").length||0<b("#signature").length){b("#message").length?a="message":b("#signature").length&&(a="signature");if(!a||!b("#"+a).length)return!1;new r(a)}c.length&&(c.prop("id","dvz_shoutbox_input"),new r("dvz_shoutbox_input"));b(".quick_edit_button").click(m);b("#quick_reply_submit").click(w)});t.autoComplete={setup:function(c){b.extend(v,c.lang||{});delete c.lang;b.extend(f,c||{});b("minLength maxLength maxItems fullText showAvatars lockSelection".split(" ")).each(function(){"undefined"!==
typeof f[this]&&(f[this]=parseInt(f[this],10))});f.defaultAvatar=f.imageDirectory+"/default_avatar.png"}};return t}(jQuery,MentionMe||{});