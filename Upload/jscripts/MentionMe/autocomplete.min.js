/*
 * Plugin Name: MentionMe for MyBB 1.8.x
 * Copyright 2014 WildcardSearch
 * http://www.rantcentralforums.com
 *
 * this file contains a module for the auto-completion functionality
 */
var MentionMe=(function(e,o){
"use strict";
var b={minLength:2,maxLength:30,minWidth:120,maxItems:5,tid:"",fullText:0,showAvatars:1,imageDirectory:"images",lockSelection:1},t={instructions:"type a user name"},s={BACKSPACE:8,ENTER:13,SHIFT:16,CTRL:17,ALT:18,ESC:27,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,INSERT:45,DELETE:46,NUMLOCK:144},f=(function(){function z(U){var T,S,R;this.editorInterface=U;R=this.editorInterface.getContainer();this.$popup=e("#mentionme_master_popup").clone().attr("id","");this.$spinner=this.$popup.find("div.mentionme_spinner").hide();this.$input=this.$popup.find("input.mentionme_popup_input");this.$inputDiv=this.$popup.find("div.mentionme_popup_input_container");this.$body=this.$popup.find("div.mentionme_popup_body");if(typeof R==="string"&&e("#"+R).length){this.$container=e("#"+R)}else{if(typeof R==="object"&&e(R).length){this.$container=e(R)}else{return false}}this.$container.append(this.$popup);this.$popup.css({left:"-1000px",top:"-1000px"}).show();this.inputHeight=this.$inputDiv.height();T=e("<div/>");if(b.showAvatars){S=e("<img/>",{"class":"mention_user_avatar",src:b.defaultAvatar}).appendTo(T)}T.append(Array(b.maxLength+1).join("M")).addClass("mentionme_popup_item");this.$body.html(T);this.lineHeight=r(T.height())+this.editorInterface.lineHeightModifier+r(T.css("paddingTop").replace("px",""))+r(T.css("paddingBottom").replace("px",""));this.$instructions=e("<span/>",{"class":"mentionme_popup_instructions"}).html(t.instructions);this.scrollWidthDiff=this.$body.width()-this.$body[0].scrollWidth;this.keyCache=new l(this);this.nameCache=new k(this)}function O(S,R){this.keyCache.clear();this.update();this.move(S,R);this.$popup.show();this.lastSelected=null;this.select();this.visible=true;this.$body.mouseover(e.proxy(this.onMouseMove,this));this.$body.click(e.proxy(this.onClick,this));e(document).click(e.proxy(this.hide,this));this.editorInterface.bindClick(e.proxy(this.hide,this));this.$input.keydown(e.proxy(this.onKeyDown,this));this.$input.keyup(e.proxy(this.updateCheck,this));this.$input.click(e.proxy(this.onInputClick,this));this.$input.focus()}function D(){this.$popup.hide();this.$body.off("mouseover",this.onMouseMove);this.$body.off("click",this.onClick);e(document).off("click",this.hide);this.editorInterface.unbindClick(this.hide);this.$input.off("keydown",this.onKeyDown);this.$input.off("keyup",this.updateCheck);this.$input.off("click",this.onInputClick);this.visible=false;this.$input.val("")}function K(V,U){var T,S=this.nameCache.getLongestName(),R;this.width=0;if(b.showAvatars){R=e("<img/>",{"class":"mention_user_avatar",src:b.defaultAvatar}).css({left:"-1000px",top:"-1000px"}).appendTo(this.$container);this.width+=R.width();R.remove()}this.width+=r(this.$body.css("fontSize").replace("px","")*S);this.width=Math.max(b.minWidth,this.width);T={height:this.getCurrentHeight()+this.inputHeight+"px",width:r(this.width-this.scrollWidthDiff)+"px"};if(typeof V!="undefined"){T.left=V+"px"}if(typeof U!="undefined"){T.top=U+"px"}this.$popup.css(T);this.$body.css({height:this.getCurrentHeight()+"px",width:this.width})}function A(){if(!this.nameCache.isReady()){this.showSpinner();return}this.nameCache.match();this.buildItems();this.lastSelected=null;this.select();if(this.keyCache.getLength()>=b.minLength){this.nameCache.search()}}function P(){var V,Z,Y,W,R,T,S=this.nameCache.getItemsLength(),U=this.nameCache.getData(),X=(navigator.userAgent.toLowerCase().indexOf("msie")!==-1)?"hand":"pointer";this.items=this.nameCache.getItems();if(S===0&&this.spinnerVisible==false){if(this.keyCache.getLength()>0){this.clear();this.$body.html(e("<span/>",{"class":"mentionme_typed_text"}).html(this.keyCache.getText()))}else{this.showInstructions()}if(this.isVisible()){this.move()}return}this.clear();for(V=0;V<S;V++){T=this.items[V];Z=U[T]["username"];if(this.keyCache.getText()){R=T.indexOf(this.keyCache.getText());if((b.fullText&&R!==-1)||(!b.fullText&&R===0)){Z=Z.slice(0,R)+'<span class="mention_name_highlight">'+Z.slice(R,R+this.keyCache.getLength())+"</span>"+Z.slice(R+this.keyCache.getLength())}}Y="";if(b.showAvatars){W=U[T]["avatar"];if(typeof W=="undefined"||W==null||W.length==0){W=b.defaultAvatar}Y=e("<img/>",{"class":"mention_user_avatar",src:W}).one("error",function(){this.src=b.defaultAvatar})}this.$body.append(e("<div/>",{"class":"mentionme_popup_item mentionme_popup_item_"+V}).append(Y).append(Z).css({cursor:X}))}if(this.isVisible()){this.move()}}function J(){this.$body.html("");this.lastSelected=null;this.spinnerVisible=false;if(this.isVisible()){this.move()}}function x(){this.clear();this.$body.html(this.$spinner);this.spinnerVisible=true;if(this.isVisible()){this.move()}}function N(){this.clear();this.$body.html(this.$instructions)}function M(){if(this.keyCache.update()){this.update()}}function I(R){var S=this.nameCache.getItemsLength()-1;switch(R){case"last":this.selected=S;break;case"next":this.selected++;if(this.selected>S){this.selected=0}break;case"previous":this.selected--;if(this.selected<0){this.selected=S}break;case"nextPage":this.selected+=b.maxItems;if(this.selected>S){this.selected=S}break;case"previousPage":this.selected-=b.maxItems;if(this.selected<0){this.selected=0}break;default:this.selected=0;break}this.highlightSelected()}function Q(T){var S=this.$popup.find(".mentionme_popup_item_"+this.selected),U=this.$popup.find(".mentionme_popup_item_"+this.lastSelected),R=U.find("span.mention_name_highlight_on"),V=this.itemInView(S);if(this.lastSelected==this.selected||S.length==0){return}if(U.length){U.removeClass("mentionme_popup_item_on");if(R.length){R.removeClass("mention_name_highlight_on");R.addClass("mention_name_highlight")}}this.lastSelected=this.selected;if(S){if(!S.hasClass("mentionme_popup_item_on")){S.addClass("mentionme_popup_item_on")}R=S.find("span.mention_name_highlight");if(R.length){R.removeClass("mention_name_highlight");R.addClass("mention_name_highlight_on")}}if(T||(b.lockSelection!==1&&V===true)){return}if(b.lockSelection){if(this.nameCache.getItemsLength()-b.maxItems>0){this.$body.prop("scrollTop",r(S.prop("offsetTop")-this.inputHeight))}return}if(this.selected==0){this.$body.prop("scrollTop",-this.inputHeight);return}if(V>0){this.$body.prop("scrollTop",r(S.prop("offsetTop")-(this.getCurrentHeight()-this.lineHeight)-this.inputHeight));return}this.$body.prop("scrollTop",r(S.prop("offsetTop")-this.inputHeight))}function F(R){var S=R.prop("offsetTop")-this.$body.prop("scrollTop");if(S>0&&(S+this.lineHeight)<this.getCurrentHeight()){return true}return S}function u(R){switch(R.keyCode){case s.ENTER:this.editorInterface.insert();break;case s.UP:this.select("previous");break;case s.DOWN:this.select("next");break;case s.END:this.select("last");break;case s.HOME:this.select();break;case s.PAGE_UP:this.select("previousPage");break;case s.PAGE_DOWN:this.select("nextPage");break;case s.ESC:this.hide();break;case s.BACKSPACE:if(this.$input.val()===""){this.hide();this.editorInterface.focus()}return;break;default:return}R.preventDefault()}function E(R){if(this.selectEventTarget(R)){this.highlightSelected(true)}}function y(R){if(this.selectEventTarget(R)){this.editorInterface.insert()}else{R.preventDefault()}}function C(R){R.stopPropagation()}function H(W){if(!W){return false}var R=e(W.target),T,U,V,S=false;if(R.length==0||!R.hasClass("mentionme_popup_item")){return}T=R.prop("class").split(" ");while(U=T.shift()){if(typeof U!=="undefined"&&["mentionme_popup_item","mentionme_popup_item_on"].indexOf(U)===-1&&U.indexOf("mentionme_popup_item_")===0){S=true;break}}V=U.split("_");if(!S||!V||V.length==0||!V[V.length-1]){return false}this.selected=V[V.length-1];return true}function G(){if(this.nameCache.getItemsLength()===0||!this.items[this.selected]){return}return this.nameCache.getData()[this.items[this.selected]]["username"]}function m(){return(this.lineHeight*Math.max(1,Math.min(b.maxItems,this.nameCache.getItemsLength())))+this.editorInterface.heightModifier+4}function w(){return this.$input.val()}function B(){return this.lineHeight}function v(){return this.spinnerVisible}function L(){return this.visible}e.extend(z.prototype,{show:O,hide:D,move:K,update:A,buildItems:P,clear:J,showSpinner:x,showInstructions:N,updateCheck:M,select:I,highlightSelected:Q,itemInView:F,onKeyDown:u,onMouseMove:E,onClick:y,onInputClick:C,selectEventTarget:H,getSelectedName:G,getCurrentHeight:m,getInputValue:w,getLineHeight:B,spinnerIsVisible:v,isVisible:L});return z})(),l=(function(){function u(y){this.popup=y;this.clear()}function m(){this.data="";this.mirror=""}function x(){var y=false,z=this.popup.getInputValue();if(this.data!==z){y=true}this.data=z;return y}function w(){return this.data.length}function v(y){if(y!=true){return this.data.toLowerCase()}return this.data}e.extend(u.prototype,{clear:m,update:x,getLength:w,getText:v});return u})(),k=(function(){function z(F){this.data={};this.threadNames={};this.allNames={};this.ready=false;this.loading=true;this.searching=false;this.searched=[];this.items=[];this.longestName=5;this.popup=F;this.editorInterface=this.popup.editorInterface;this.keyCache=F.keyCache;e.ajax({type:"post",url:"xmlhttp.php",data:{action:"mentionme",mode:"getNameCache",tid:b.tid},success:this.loadNameCache.bind(this)})}function u(F){this.ready=true;this.loading=false;this.threadNames=F.inThread;this.allNames=F.cached;e.extend(this.data,this.threadNames,this.allNames);if(e.isEmptyObject(this.data)){this.data={};this.popup.showInstructions();if(this.popup.isVisible()){this.popup.move()}return}if(this.popup.isVisible()){this.popup.update()}}function x(){var I,G=0,F={},H=[];this.items=[];this.longestName=5;for(I in this.threadNames){if(!this.checkEntry(I,this.threadNames,F)){continue}this.items.push(I);F[I]=true;G++}for(I in this.data){if(!this.checkEntry(I,this.data,F)){continue}H.push(I);F[I]=true;G++}H=H.sort(c);e.merge(this.items,H);return G}function A(H,G,F){if(!G.hasOwnProperty(H)||!G[H]||F[H]||(this.keyCache.getLength()&&((!b.fullText&&H.slice(0,this.keyCache.getLength())!==this.keyCache.getText())||(b.fullText&&H.indexOf(this.keyCache.getText())===-1)))){return false}if(H.length>this.longestName){this.longestName=H.length}return true}function E(){var F=this.keyCache.getText().slice(0,b.minLength);if(this.searching||this.searched.indexOf(F)!==-1){if(this.popup.spinnerIsVisible()){this.popup.hide();this.editorInterface.focus()}return}this.searched.push(F);this.searching=true;if(this.items.length===0){this.popup.showSpinner()}e.ajax({type:"post",url:"xmlhttp.php",data:{action:"mentionme",mode:"nameSearch",search:F},success:C.bind(this)})}function C(G){var H=0,F;this.searching=false;if(!G){if(this.popup.spinnerIsVisible()){this.popup.hide();this.editorInterface.focus()}return}for(F in G){if(!G.hasOwnProperty(F)||this.data[F]){continue}this.data[F]=G[F];H++}if(!H||!this.popup.isVisible()){return}this.match();this.popup.buildItems();this.popup.select()}function B(){return this.ready}function y(){return this.loading}function w(){return this.data}function v(){return this.items}function m(){return this.items.length}function D(){return this.longestName}e.extend(z.prototype,{loadNameCache:u,match:x,checkEntry:A,search:E,load:C,isReady:B,isLoading:y,getData:w,getItems:v,getItemsLength:m,getLongestName:D});return z})(),d=(function(){function m(F){this.$textarea=e("#"+F);this.$container=this.$textarea.closest("div");this.selection={start:0,end:0};this.popup=new f(this);this.bindKeyup()}function E(F){if(this.popup.isVisible()){return}this.getCaret();if(i(F.keyCode)&&this.$textarea.val().slice(this.selection.start-1,this.selection.end)=="@"){this.showPopup()}}function C(){var F=this.$textarea.caret("offset"),H=F.left+3,G=F.top-5;this.popup.show(H,G)}function u(){var F=p(this.popup);if(!F){if(!this.popup.spinnerIsVisible()){this.popup.hide()}return}this.getCaret();this.$textarea.val(this.$textarea.val().slice(0,this.selection.start)+F+this.$textarea.val().slice(this.selection.start));this.setCaret(this.selection.start+F.length);this.popup.hide()}function x(){var F=this.$textarea.caret("pos");this.selection.start=F;this.selection.end=F}function w(F){var H=this.$textarea[0],G;if(H.setSelectionRange){H.focus();H.setSelectionRange(F,F)}else{if(H.createTextRange){G=H.createTextRange();G.collapse(true);G.moveEnd("character",F);G.moveStart("character",F);G.select()}}}function z(F){this.$textarea.click(F)}function v(F){this.$textarea.off("click",F)}function B(){this.$textarea.keyup(e.proxy(this.onKeyUp,this))}function y(){this.$textarea.off("keyup")}function D(){this.$textarea.focus()}function A(){return this.$container}e.extend(m.prototype,{heightModifier:0,lineHeightModifier:0,onKeyUp:E,showPopup:C,insert:u,getCaret:x,setCaret:w,bindClick:z,unbindClick:v,bindKeyup:B,unbindKeyup:y,focus:D,getContainer:A});return m})(),a=(function(){function w(){this.editor=MyBBEditor;this.rangeHelper=this.editor.getRangeHelper();this.$iFrame=e("div.sceditor-toolbar").next("iframe");this.$container=this.$iFrame.closest(".sceditor-container").parent();this.$body=this.editor.getBody();this.selection={start:0,end:0};this.popup=new f(this);this.editor.keyUp(this.onKeyUp.bind(this))}function A(C){this.getCaret();if(!C.keyCode){if(C.originalEvent&&C.originalEvent.keyCode){C.keyCode=C.originalEvent.keyCode}else{return}}if(!this.popup.isVisible()){if(i(C.keyCode)&&this.$currentNode.text().slice(this.selection.start-1,this.selection.end)=="@"){this.showPopup()}return}}function z(){var E,G,F,D=this.$body.caret("offset",{iframe:this.$iFrame[0]}),C=this.$container.offset();E=7;if(this.$currentNode.closest("div").length&&typeof this.$currentNode.closest("div").css==="function"){E=r(this.$currentNode.closest("div").css("fontSize").replace("px","")/2)}G=r(D.left)+C.left+r(this.$container.css("paddingLeft").replace("px",""))+E+2;F=r(D.top+this.$container.find("div.sceditor-toolbar").height())+C.top+r(this.$container.css("paddingTop").replace("px",""))+3;this.popup.show(G,F)}function m(){var C=p(this.popup);if(!C){if(!this.popup.spinnerIsVisible()){this.popup.hide()}return}this.editor.insert(C);this.popup.hide()}function v(){var C=this.rangeHelper.selectedRange();if(C.startContainer){this.$currentNode=e(C.startContainer)}else{this.$currentNode=e(editor.currentNode())}this.selection.start=C.startOffset;this.selection.end=C.endOffset}function x(C){this.$body.click(C)}function u(C){this.$body.off("click",C)}function B(){this.$iFrame.focus()}function y(){return this.$container}e.extend(w.prototype,{heightModifier:0,lineHeightModifier:0,onKeyUp:A,showPopup:z,insert:m,getCaret:v,bindClick:x,unbindClick:u,focus:B,getContainer:y});return w})(),j=(function(){function m(I){if(e("#"+I).length===0||typeof CKEDITOR.instances[I]==="undefined"){return}this.finalized=false;this.id=I;this.editor=CKEDITOR.instances[this.id];if(this.editor.status!="ready"){this.editor.on("instanceReady",e.proxy(this.finalize,this))}else{this.finalize()}e("#quick_reply_submit").click(e.proxy(this.quickReplyPosted,this))}function D(){if(this.editor.mode=="wysiwyg"){this.doFinalize()}this.lastState=this.editor.mode;this.editor.on("mode",e.proxy(this.onModeChange,this))}function E(){this.$iFrame=e("#cke_"+this.id).find("iframe");this.$container=this.$iFrame.closest("div");this.$doc=e(this.editor.document.$);this.$body=this.$doc.find("body");this.bindKeyup();this.popup=new f(this);this.finalized=true}function B(I){if(typeof I.sender.mode=="undefined"||I.sender.mode==this.lastState){return}this.lastState=I.sender.mode;if(this.finalized){this.unbindKeyup()}if(I.sender.mode!="source"){this.doFinalize()}}function H(I){if(!this.popup.isVisible()){if(i(I.keyCode)&&this.getPrevChar()=="@"){this.showPopup()}return}}function w(){if(typeof this.$doc!=="undefined"&&this.$doc.length){this.$doc.off("keyup",this.onKeyUp)}setTimeout(e.proxy(function(){this.$doc.keyup(e.proxy(this.onKeyUp,this))},this),500)}function F(){var I=this.$body.caret("offset",{iframe:this.$iFrame[0]}),L=this.$iFrame.offset(),K=r(I.left+L.left)+2,J=r(I.top+L.top)-5;this.popup.show(K,J)}function v(){var I=p(this.popup);if(!I){if(!this.popup.spinnerIsVisible()){this.popup.hide()}return}this.editor.insertText(I);this.popup.hide()}function y(){var J,L,K,I=this.editor.getSelection().getRanges()[0];if(!I||!I.startContainer){return null}J=I.startContainer;if(J.type==CKEDITOR.NODE_TEXT&&I.startOffset){return J.getText()[I.startOffset-1]}else{I.collapse(true);I.setStartAt(this.editor.editable(),CKEDITOR.POSITION_AFTER_START);L=new CKEDITOR.dom.walker(I);while(K=L.previous()){if(K.type==CKEDITOR.NODE_TEXT){return K.getText().slice(-1)}}}return null}function z(I){this.$doc.click(I)}function u(I){this.$doc.off("click",I)}function C(){this.$doc.keyup(e.proxy(this.onKeyUp,this))}function x(){this.$doc.off("keyup",this.onKeyUp)}function G(){this.editor.focus()}function A(){return this.$container}e.extend(m.prototype,{heightModifier:0,lineHeightModifier:0,finalize:D,doFinalize:E,onModeChange:B,onKeyUp:H,quickReplyPosted:w,showPopup:F,insert:v,getPrevChar:y,bindClick:z,unbindClick:u,bindKeyup:C,unbindKeyup:x,focus:G,getContainer:A});return m})();function n(m){e.extend(t,m.lang||{});delete m.lang;e.extend(b,m||{});e(["minLength","maxLength","minWidth","maxItems","fullText","showAvatars","lockSelection"]).each(function(){if(typeof b[this]!=="undefined"){b[this]=r(b[this])}});b.defaultAvatar=b.imageDirectory+"/default_avatar.png"}function q(){var v,u,m=e('.panel > form > input[class="text"]');if(typeof CKEDITOR!=="undefined"&&typeof CKEDITOR.instances!=="undefined"){u=e.map(CKEDITOR.instances,function(x,w){return w})[0];if(typeof CKEDITOR.instances[u]!=="object"){return false}new j(u)}else{if(MyBBEditor!==null&&typeof MyBBEditor==="object"&&MyBBEditor.getRangeHelper&&typeof MyBBEditor.getRangeHelper==="function"){new a()}else{if(e("#message").length>0||e("#signature").length>0){if(e("#message").length){v="message"}else{if(e("#signature").length){v="signature"}}if(!v||!e("#"+v).length){return false}new d(v)}}}if(m.length){m.prop("id","dvz_shoutbox_input");new d("dvz_shoutbox_input")}e(".quick_edit_button").click(g);e("#quick_reply_submit").click(h)}function g(v){var m=this.id.split("_").slice(-1)[0],w="quickedit_"+m,u;if(e("#"+w).length==0){return}if(typeof CKEDITOR==="undefined"){u=new d(w)}else{setTimeout(function(){u=new j(w)},1100)}setTimeout(function(){e("#quicksub_"+m).add(e("#quicksub_"+m).next("button")).click(function(){u.unbindKeyup()})},1100)}function h(m){e(".quick_edit_button").off("click",g);setTimeout(function(){e(".quick_edit_button").click(g)},500)}function p(m){var v=m.getSelectedName(),u="";if(!v){return}if(v.indexOf('"')==-1){u='"'}else{if(v.indexOf("'")==-1){u="'"}else{if(v.indexOf("`")==-1){u="`"}}}return u+v+u+" "}function i(m){return[s.LEFT,s.RIGHT,s.UP,s.DOWN,s.BACKSPACE,s.ESC,s.SHIFT,s.CTRL,s.ALT,s.ENTER,s.DELETE,s.INSERT,s.END,s.NUMLOCK].indexOf(m)===-1}function c(u,m){if(u.length<m.length){return -1}else{if(u.length>m.length){return 1}else{return 0}}}function r(m){return parseInt(m,10)}e(q);o.autoComplete={setup:n};return o})(jQuery,MentionMe||{});